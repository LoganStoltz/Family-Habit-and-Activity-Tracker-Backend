name: CI

on:
  pull_request:
  push:
    branches: [ main ]

  jobs:
    test:
      runs-on: ubuntu-latest
      services:
        postgres:
          image: postgres:15
          env:
            POSTGRES_USER: postgres
            POSTGRES_PASSWORD: postgres
            POSTGRES_DB: family_habit_test
          ports:
            - 5432:5432
          options: >-
            --health-cmd "pg_isready -U postgres"
            --health-interval 10s
            --health-timeout 5s
            --health-retries 5

      env:
        RAILS_ENV: test
        DATABASE_URL: postgresql://postgres:postgres@127.0.0.1:5432/family_habit_test

      steps:
        - uses: actions/checkout@v4

        - name: Set up Ruby
          uses: ruby/setup-ruby@v1
          with:
            ruby-version: 3.4

        - name: Install dependencies
          run: bundle config set --local deployment 'true' && bundle install --jobs 4 --retry 3

        - name: Install psql client (for pg_isready)
          run: sudo apt-get update && sudo apt-get install -y postgresql-client

        - name: Wait for Postgres to accept connections
          run: |
            for i in $(seq 1 30); do
              if pg_isready -h 127.0.0.1 -p 5432 -U postgres; then
                echo "Postgres is ready"
                break
              fi
              echo "Waiting for Postgres..."
              sleep 1
            done

        - name: Prepare DB
          run: |
            bundle exec rails db:create db:schema:load RAILS_ENV=test

  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: .ruby-version
          bundler-cache: true

      - name: Ensure rubocop is executable
        run: chmod +x bin/rubocop

      - name: Lint code for consistent style
        run: bundle exec rubocop -f github

  test:
    runs-on: ubuntu-latest
    steps:
      - name: Install packages
        run: sudo apt-get update && sudo apt-get install --no-install-recommends -y build-essential git libyaml-dev pkg-config

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: .ruby-version
          bundler-cache: true

      - name: Ensure rails binstub is executable
        run: chmod +x bin/rails

      - name: Run tests
        env:
          RAILS_ENV: test
        run: bundle exec rails db:test:prepare test
  
  services:
    postgres:
      image: postgres:14
      ports:
        - 5432:5432
      env:
        POSTGRES_USER: postgres
        POSTGRES_PASSWORD: postgres
        POSTGRES_DB: test_db
      options: >-
        --health-cmd="pg_isready"
        --health-interval=10s
        --health-timeout=5s
        --health-retries=5
